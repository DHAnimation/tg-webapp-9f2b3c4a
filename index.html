<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–û–ø–ª–∞—Ç–∞ –Ω–æ–º–µ—Ä–∫–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="robots" content="noindex,nofollow" />

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--tg-theme-secondary-bg-color, #f3f3f3);
      color: var(--tg-theme-text-color, #000000);
    }

    .card {
      max-width: 480px;
      margin: 0 auto;
      background: var(--tg-theme-bg-color, #ffffff);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    #loader-view {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 250px;
      text-align: center;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--tg-theme-hint-color, #ddd);
      border-top-color: var(--tg-theme-button-color, #4caf50);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loader-text {
      font-size: 16px;
      color: var(--tg-theme-text-color, #000);
      font-weight: 500;
    }

    #form-view {
      display: none;
    }

    h2 {
      margin: 0 0 12px;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
    }

    .warning {
      margin: 0 0 16px;
      padding: 10px 12px;
      border-radius: 8px;
      background: #fff4cf;
      border: 1px solid #f5d96b;
      font-size: 13px;
      line-height: 1.4;
      color: #5c4b00;
    }

    .field {
      margin-bottom: 12px;
    }

    .field-label {
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 14px;
      color: var(--tg-theme-hint-color, #777);
    }

    .field-box {
      padding: 10px;
      border-radius: 8px;
      background: var(--tg-theme-secondary-bg-color, #fafafa);
      border: 1px solid var(--tg-theme-hint-color, #ddd);
      font-size: 15px;
      white-space: pre-line;
      color: var(--tg-theme-text-color, #000);
    }

    input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--tg-theme-hint-color, #ccc);
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
      font-size: 16px; 
      box-sizing: border-box;
      outline: none;
    }
    
    input:focus {
      border-color: var(--tg-theme-button-color, #4caf50);
    }

    .hint {
      margin-top: 4px;
      color: var(--tg-theme-hint-color, #999);
      font-size: 12px;
    }

    .btn-row {
      margin-top: 20px;
    }

    button {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: var(--tg-theme-button-color, #4caf50);
      color: var(--tg-theme-button-text-color, #fff);
      transition: opacity 0.2s;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 16px;
      font-size: 15px;
    }

    .checkbox-row input {
      width: 20px;
      height: 20px;
      margin: 0;
      accent-color: var(--tg-theme-button-color, #4caf50);
    }

    .copy-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .copy-btn {
      width: auto;
      flex: 1 1 0;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      background: var(--tg-theme-secondary-bg-color, #f0f0f0);
      color: var(--tg-theme-text-color, #000);
      border: 1px solid var(--tg-theme-hint-color, #ccc);
      cursor: pointer;
    }

    .copy-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ / –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ª–æ—Ç–∞ -->
    <div id="loader-view">
      <div class="spinner"></div>
      <div class="loader-text" id="loader-msg">–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –±–∏–ª–µ—Ç–∞...</div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
    <div id="form-view">
      <h2 id="title">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>

      <div class="warning">
        <b>–í–ù–ò–ú–ê–ù–ò–ï!</b> –ë–∏–ª–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω –∑–∞ –≤–∞–º–∏ –Ω–∞ 5 –º–∏–Ω—É—Ç.<br>
        –ï—Å–ª–∏ –≤—ã –∑–∞–∫—Ä–æ–µ—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ, –±—Ä–æ–Ω—å —Å–Ω–∏–º–µ—Ç—Å—è.<br>
        –ü–µ—Ä–µ–≤–æ–¥–∏—Ç–µ —Ç–æ—á–Ω–æ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É.
      </div>

      <div class="field">
        <div class="field-label">–°—É–º–º–∞ –∫ –ø–µ—Ä–µ–≤–æ–¥—É</div>
        <div class="field-box" id="amount-box">‚Äî ‚ÇΩ</div>
      </div>

      <div class="field">
        <div class="field-label">–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã (–°–ë–ü, –∫–∞—Ä—Ç–∞)</div>
        <div class="field-box" id="details-box">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="copy-row">
          <button type="button" class="copy-btn" id="copy-phone-btn">üìã –¢–µ–ª–µ—Ñ–æ–Ω</button>
          <button type="button" class="copy-btn" id="copy-card-btn">üìã –ö–∞—Ä—Ç–∞</button>
        </div>
      </div>

      <div class="field">
        <div class="field-label">–í–∞—à–∏ –§–ò–û (–∫–∞–∫ –≤ –±–∞–Ω–∫–µ)</div>
        <input id="fio-input" type="text" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" autocomplete="off" />
        <div class="hint">
          –ù—É–∂–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
        </div>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="paid-checkbox" />
        <label for="paid-checkbox">–Ø –ø–µ—Ä–µ–≤—ë–ª –¥–µ–Ω—å–≥–∏ –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º</label>
      </div>

      <div class="btn-row">
        <button id="submit-btn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = "https://ufa-bot-dhanimation.amvera.io";
    const URL_LOCK   = BASE_URL + "/webapp/lock";
    const URL_PAID   = BASE_URL + "/webapp/paid";
    const URL_UNLOCK = BASE_URL + "/webapp/unlock";

    const tg = window.Telegram.WebApp;

    function b64DecodeUnicode(str) {
      if (!str) return "";
      str = str.replace(/-/g, "+").replace(/_/g, "/");
      while (str.length % 4) { str += "="; }
      try {
        return decodeURIComponent(atob(str).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
      } catch (e) {
        console.error("Decode error", e);
        return "";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      tg.ready();
      try { tg.expand(); } catch (e) {}

      document.body.style.backgroundColor =
        tg.themeParams.secondary_bg_color || "#f3f3f3";

      // --- –†–∞–∑–±–æ—Ä start_param ---
      let rawParam = "";
      if (tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
        rawParam = b64DecodeUnicode(tg.initDataUnsafe.start_param);
      }

      let gameId = null;
      let slot   = null;
      let price  = null;
      let bank = "", payName = "", payPhone = "", payCard = "";

      if (rawParam) {
        const parts = rawParam.split(":");
        if (parts.length >= 3) {
          gameId = parseInt(parts[0]);
          slot   = parseInt(parts[1]);
          price  = parseInt(parts[2]);
        }
        if (parts.length >= 4) {
          const rest = parts.slice(3).join(":");
          const splitted = rest.split("|");
          bank     = splitted[0] || "";
          payName  = splitted[1] || "";
          payPhone = splitted[2] || "";
          payCard  = splitted[3] || "";
        }
      }

      const loaderView = document.getElementById("loader-view");
      const loaderMsg  = document.getElementById("loader-msg");
      const formView   = document.getElementById("form-view");

      if (!gameId || !slot) {
        loaderMsg.textContent = "–û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É.";
        return;
      }

      const userId   = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id       : 0;
      const username = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.username : null;

      let submitted = false; // true, –µ—Å–ª–∏ –∑–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ (—Ç–æ–≥–¥–∞ –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º)

      // --- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–ª–æ—Ç–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ ---
      fetch(URL_LOCK, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({
          game_id: gameId,
          slot:    slot,
          user_id: userId,
          username: username
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          showForm();
        } else {
          const errorText = data.error || "–≠—Ç–æ—Ç —Å–ª–æ—Ç —É–∂–µ –∑–∞–Ω—è—Ç –∫–µ–º-—Ç–æ –¥—Ä—É–≥–∏–º –∏–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω–∞—è –±—Ä–æ–Ω—å.";
          tg.showPopup({
            title: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω",
            message: errorText,
            buttons: [{ type: "close" }]
          }, function () {
            tg.close();
          });
          loaderMsg.textContent = errorText;
        }
      })
      .catch(err => {
        console.error(err);
        loaderMsg.textContent = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.";
        tg.showPopup({
          title: "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏",
          message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å –±–æ—Ç–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.",
          buttons: [{ type: "close" }]
        });
      });

      function showForm() {
        loaderView.style.display = "none";
        formView.style.display   = "block";

        document.getElementById("title").textContent =
          `–ò–≥—Ä–∞ #${gameId}, –ë–∏–ª–µ—Ç #${slot}`;

        document.getElementById("amount-box").textContent =
          price ? `${price} ‚ÇΩ` : "‚Äî";

        let detailsHtml = "";
        detailsHtml += `–ë–∞–Ω–∫: <b>${bank || "‚Äî"}</b><br>`;
        detailsHtml += `–ü–æ–ª—É—á–∞—Ç–µ–ª—å: <b>${payName || "‚Äî"}</b><br>`;
        detailsHtml += `–¢–µ–ª–µ—Ñ–æ–Ω: <b>${payPhone || "‚Äî"}</b><br>`;
        detailsHtml += `–ö–∞—Ä—Ç–∞: <b>${payCard || "‚Äî"}</b>`;

        document.getElementById("details-box").innerHTML = detailsHtml;

        // —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã, –µ—Å–ª–∏ –∫–∞—Ä—Ç—ã –Ω–µ—Ç
        const copyCardBtn = document.getElementById("copy-card-btn");
        if (!payCard) {
          copyCardBtn.disabled = true;
        }
      }

      // --- –†–∞–±–æ—Ç–∞ —Å —Ñ–æ—Ä–º–æ–π ---
      const fioInput      = document.getElementById("fio-input");
      const paidCheckbox  = document.getElementById("paid-checkbox");
      const submitBtn     = document.getElementById("submit-btn");
      const copyPhoneBtn  = document.getElementById("copy-phone-btn");
      const copyCardBtn   = document.getElementById("copy-card-btn");

      function updateBtn() {
        const hasFio = fioInput.value.trim().length >= 2;
        submitBtn.disabled = !(hasFio && paidCheckbox.checked);
      }

      fioInput.addEventListener("input",  updateBtn);
      paidCheckbox.addEventListener("change", updateBtn);

      function copyText(value, label) {
        if (!value) return;
        const msg = label || "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(value).then(() => {
            try {
              tg.showPopup({
                title: "–ì–æ—Ç–æ–≤–æ",
                message: msg,
                buttons: [{ type: "ok" }]
              });
            } catch (e) {
              alert(msg);
            }
          }).catch(() => {
            try {
              tg.showPopup({
                title: "–û—à–∏–±–∫–∞",
                message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.",
                buttons: [{ type: "close" }]
              });
            } catch (e) {
              alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.");
            }
          });
        } else {
          // fallback
          const textarea = document.createElement("textarea");
          textarea.value = value;
          textarea.style.position = "fixed";
          textarea.style.opacity = "0";
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          try {
            document.execCommand("copy");
            try {
              tg.showPopup({
                title: "–ì–æ—Ç–æ–≤–æ",
                message: msg,
                buttons: [{ type: "ok" }]
              });
            } catch (e) {
              alert(msg);
            }
          } catch (e) {
            try {
              tg.showPopup({
                title: "–û—à–∏–±–∫–∞",
                message: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.",
                buttons: [{ type: "close" }]
              });
            } catch (e2) {
              alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.");
            }
          }
          document.body.removeChild(textarea);
        }
      }

      copyPhoneBtn.addEventListener("click", () => {
        copyText(payPhone, "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω.");
      });

      copyCardBtn.addEventListener("click", () => {
        if (!payCard) return;
        copyText(payCard, "–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω.");
      });

      submitBtn.addEventListener("click", () => {
        const fio = fioInput.value.trim();
        if (!fio) return;
        if (submitted) return;

        submitted = true;
        submitBtn.disabled = true;
        submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

        const payload = {
          game_id: gameId,
          slot:    slot,
          fio:     fio,
          user_id: userId,
          username: username
        };

        fetch(URL_PAID, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            tg.showPopup({
              title: "–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!",
              message: "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç –æ–ø–ª–∞—Ç—É –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –Ω–æ–º–µ—Ä–æ–∫.",
              buttons: [{ type: "ok" }]
            }, function () {
              tg.close();
            });
          } else {
            submitted = false;
            tg.showPopup({
              title: "–û—à–∏–±–∫–∞",
              message: data.error || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
              buttons: [{ type: "close" }]
            });
            submitBtn.disabled = false;
            submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É";
          }
        })
        .catch(err => {
          console.error(err);
          submitted = false;
          tg.showPopup({
            title: "–û—à–∏–±–∫–∞",
            message: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ.",
            buttons: [{ type: "close" }]
          });
          submitBtn.disabled = false;
          submitBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É";
        });
      });

      // --- –§—É–Ω–∫—Ü–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–ª–æ—Ç–∞ ---
      function sendUnlock() {
        // –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚Äì –ù–ò–ß–ï–ì–û –Ω–µ –¥–µ–ª–∞–µ–º
        if (submitted) return;
        if (!gameId || !slot || !userId) return;

        const payload = JSON.stringify({
          game_id: gameId,
          slot:    slot,
          user_id: userId
        });

        try {
          const blob = new Blob([payload], { type: "application/json" });
          navigator.sendBeacon(URL_UNLOCK, blob);
        } catch (e) {
          try {
            fetch(URL_UNLOCK, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: payload,
              keepalive: true
            });
          } catch (err) {
            console.error("unlock fetch error", err);
          }
        }
      }

      // 1) –û—Å–Ω–æ–≤–Ω–æ–µ: Telegram-—Å–æ–±—ã—Ç–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è WebApp (–∫–Ω–æ–ø–∫–∞-–∫—Ä–µ—Å—Ç–∏–∫)
      tg.onEvent("webview_closed", () => {
        sendUnlock();
      });

      // 2) –†–µ–∑–µ—Ä–≤: –µ—Å–ª–∏ –≤—Å–µ-—Ç–∞–∫–∏ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤–∫–ª–∞–¥–∫–∏
      window.addEventListener("beforeunload", () => {
        sendUnlock();
      });
    });
  </script>
</body>
</html>
