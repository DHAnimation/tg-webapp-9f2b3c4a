<script>
    // Функция для декодирования Base64 с поддержкой русских букв (UTF-8)
    function b64DecodeUnicode(str) {
      // Добавляем обратно "=" если их обрезали
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      while (str.length % 4) { str += '='; }
      
      return decodeURIComponent(atob(str).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
    }

    document.addEventListener("DOMContentLoaded", () => {
      const tg = window.Telegram && window.Telegram.WebApp 
        ? window.Telegram.WebApp 
        : null;

      // Сразу сообщаем Telegram, что мы готовы. 
      // Это уберет спиннер загрузки, даже если код ниже упадет с ошибкой.
      if (tg) {
        tg.expand();
        tg.ready();
      }

      let rawParam = "";
      
      // Получаем параметр запуска
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
        rawParam = tg.initDataUnsafe.start_param;
      }

      let gameId = null;
      let slot = null;
      let price = null;
      let bank = "";
      let payName = "";
      let payPhone = "";

      if (rawParam) {
        try {
          // Декодируем Base64 обратно в строку "1:5:100:Банк|Имя|Телефон"
          const decoded = b64DecodeUnicode(rawParam);
          
          const parts = decoded.split(":");

          if (parts.length >= 3) {
            const g = parseInt(parts[0], 10);
            const s = parseInt(parts[1], 10);
            const p = parseInt(parts[2], 10);

            gameId = Number.isNaN(g) ? null : g;
            slot   = Number.isNaN(s) ? null : s;
            price  = Number.isNaN(p) ? null : p;
          }

          if (parts.length >= 4) {
            // Собираем оставшуюся часть (реквизиты) обратно, если вдруг в них были двоеточия
            const rest = parts.slice(3).join(":");
            const splitted = rest.split("|");
            bank = splitted[0] || "";
            payName = splitted[1] || "";
            payPhone = splitted[2] || "";
          }
        } catch (e) {
          console.error("Ошибка декодирования параметров:", e);
          if (tg) tg.showAlert("Ошибка чтения параметров игры.");
        }
      }

      // --- Отрисовка интерфейса ---
      
      const titleEl = document.getElementById("title");
      if (gameId && slot) {
        titleEl.textContent = `Игра #${gameId}, номерок #${slot}`;
      } else {
        titleEl.textContent = "Ошибка данных";
      }

      const amountEl = document.getElementById("amount-box");
      amountEl.textContent = price ? `${price} ₽` : "? ₽";

      const detailsEl = document.getElementById("details-box");
      detailsEl.textContent =
`Банк: ${bank || "—"}
Получатель: ${payName || "—"}
Номер: ${payPhone || "—"}`;

      // --- Логика формы ---

      const fioInput = document.getElementById("fio-input");
      const paidCheckbox = document.getElementById("paid-checkbox");
      const submitBtn = document.getElementById("submit-btn");

      function updateButtonState() {
        const fioOk = fioInput.value.trim().length >= 3;
        submitBtn.disabled = !(fioOk && paidCheckbox.checked);
      }

      fioInput.addEventListener("input", updateButtonState);
      paidCheckbox.addEventListener("change", updateButtonState);

      submitBtn.addEventListener("click", () => {
        const fio = fioInput.value.trim();
        
        if (!gameId || !slot) {
          tg.showAlert("Данные игры не загрузились. Перезапустите.");
          return;
        }

        const payload = {
          game_id: gameId,
          slot: slot,
          fio: fio,
        };

        const msg = 
          "Ваш номерок забронирован.\n" + 
          "Ожидайте подтверждения администратора.";

        tg.showAlert(msg);
        tg.sendData(JSON.stringify(payload));
        // Закрытие происходит автоматически после sendData, но можно явно:
        // tg.close(); 
      });
    });
  </script>
