<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Оплата номерка</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="robots" content="noindex,nofollow" />

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--tg-theme-secondary-bg-color, #f3f3f3);
      color: var(--tg-theme-text-color, #000000);
    }

    .card {
      max-width: 480px;
      margin: 0 auto;
      background: var(--tg-theme-bg-color, #ffffff);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    /* Экран загрузки */
    #loader-view {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      text-align: center;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #ddd;
      border-top-color: #4caf50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Основная форма (скрыта по умолчанию) */
    #form-view {
      display: none; 
    }

    h2 {
      margin: 0 0 12px;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
    }

    .warning {
      margin: 0 0 16px;
      padding: 10px 12px;
      border-radius: 8px;
      background: #fff4cf;
      border: 1px solid #f5d96b;
      font-size: 13px;
      line-height: 1.4;
      color: #5c4b00;
    }

    .field {
      margin-bottom: 12px;
    }

    .field-label {
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 14px;
      color: var(--tg-theme-hint-color, #777);
    }

    .field-box {
      padding: 10px;
      border-radius: 8px;
      background: var(--tg-theme-secondary-bg-color, #fafafa);
      border: 1px solid var(--tg-theme-hint-color, #ddd);
      font-size: 15px;
      white-space: pre-line;
      color: var(--tg-theme-text-color, #000);
    }

    input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--tg-theme-hint-color, #ccc);
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
      font-size: 16px; 
      box-sizing: border-box;
      outline: none;
    }
    
    input:focus {
      border-color: #4caf50;
    }

    .hint {
      margin-top: 4px;
      color: var(--tg-theme-hint-color, #999);
      font-size: 12px;
    }

    .btn-row {
      margin-top: 20px;
    }

    button {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: var(--tg-theme-button-color, #4caf50);
      color: var(--tg-theme-button-text-color, #fff);
      transition: opacity 0.2s;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 16px;
      font-size: 15px;
    }

    .checkbox-row input {
      width: 20px;
      height: 20px;
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- Экран загрузки / Блокировки -->
    <div id="loader-view">
      <div class="spinner"></div>
      <div id="loader-text">Проверяем доступность номерка...</div>
    </div>

    <!-- Основная форма -->
    <div id="form-view">
      <h2 id="title">Загрузка...</h2>

      <div class="warning">
        <b>ВНИМАНИЕ!</b> Номерок забронирован за вами на 15 минут.
        Заполните данные и нажмите кнопку, иначе бронь слетит.
      </div>

      <div class="field">
        <div class="field-label">Сумма к переводу</div>
        <div class="field-box" id="amount-box">— ₽</div>
      </div>

      <div class="field">
        <div class="field-label">Реквизиты для оплаты (СБП)</div>
        <div class="field-box" id="details-box">Загрузка...</div>
      </div>

      <div class="field">
        <div class="field-label">Ваши ФИО (как в банке)</div>
        <input id="fio-input" type="text" placeholder="Иванов Иван Иванович" autocomplete="off" />
        <div class="hint">
          Нужно для проверки платежа администратором.
        </div>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="paid-checkbox" />
        <label for="paid-checkbox">Я перевёл деньги по реквизитам</label>
      </div>

      <div class="btn-row">
        <button id="submit-btn" disabled>Отправить заявку</button>
      </div>
    </div>
  </div>

  <script>
    // === ВАЖНО: АДРЕС СЕРВЕРА ===
    // Оставь здесь свой адрес на Amvera
    const BASE_URL = "https://ufa-bot-dhanimation.amvera.io"; 
    
    const URL_LOCK = BASE_URL + "/webapp/lock";
    const URL_PAID = BASE_URL + "/webapp/paid";

    const tg = window.Telegram.WebApp;

    function b64DecodeUnicode(str) {
      if (!str) return "";
      str = str.replace(/-/g, "+").replace(/_/g, "/");
      while (str.length % 4) { str += "="; }
      try {
        return decodeURIComponent(atob(str).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
      } catch (e) {
        console.error("Decode error", e);
        return "";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      tg.ready();
      try { tg.expand(); } catch(e){}
      
      // Настройка цветов
      document.body.style.backgroundColor = tg.themeParams.secondary_bg_color || "#f3f3f3";

      // 1. Парсинг параметров
      let rawParam = "";
      if (tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
        rawParam = b64DecodeUnicode(tg.initDataUnsafe.start_param);
      }

      let gameId = null;
      let slot = null;
      let price = null;
      let bank = "", payName = "", payPhone = "";

      if (rawParam) {
        const parts = rawParam.split(":");
        if (parts.length >= 3) {
          gameId = parseInt(parts[0]);
          slot = parseInt(parts[1]);
          price = parseInt(parts[2]);
        }
        if (parts.length >= 4) {
          const rest = parts.slice(3).join(":");
          const splitted = rest.split("|");
          bank = splitted[0] || "";
          payName = splitted[1] || "";
          payPhone = splitted[2] || "";
        }
      }

      const loaderView = document.getElementById("loader-view");
      const loaderText = document.getElementById("loader-text");
      const formView = document.getElementById("form-view");

      if (!gameId || !slot) {
        loaderText.textContent = "Ошибка: неверные данные игры.";
        return;
      }

      // 2. БЛОКИРОВКА СЛОТА (Моментальный запрос при открытии)
      const user = tg.initDataUnsafe.user;
      const userId = user ? user.id : 0;
      const username = user ? user.username : null;

      fetch(URL_LOCK, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          game_id: gameId,
          slot: slot,
          user_id: userId,
          username: username
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          // УСПЕХ: Слот забронирован, показываем форму
          showForm();
        } else {
          // ОШИБКА: Слот занят или у юзера уже есть долг
          tg.showPopup({
            title: "Недоступно",
            message: data.error || "Этот номерок уже занят или у вас есть неоплаченная бронь.",
            buttons: [{type: "close"}]
          }, function() {
            tg.close();
          });
        }
      })
      .catch(err => {
        loaderText.textContent = "Ошибка сети. Попробуйте позже.";
      });

      // Функция отображения формы
      function showForm() {
        loaderView.style.display = "none";
        formView.style.display = "block";

        const titleEl = document.getElementById("title");
        titleEl.textContent = `Игра #${gameId}, Билет #${slot}`;

        document.getElementById("amount-box").textContent = price ? `${price} ₽` : "—";
        document.getElementById("details-box").innerHTML = `
          Банк: <b>${bank}</b><br>
          Получатель: <b>${payName}</b><br>
          Телефон: <b>${payPhone}</b>
        `;
      }

      // 3. Логика отправки оплаты
      const fioInput = document.getElementById("fio-input");
      const paidCheckbox = document.getElementById("paid-checkbox");
      const submitBtn = document.getElementById("submit-btn");

      function updateBtn() {
        const hasFio = fioInput.value.trim().length >= 2;
        submitBtn.disabled = !(hasFio && paidCheckbox.checked);
      }

      fioInput.addEventListener("input", updateBtn);
      paidCheckbox.addEventListener("change", updateBtn);

      submitBtn.addEventListener("click", () => {
        const fio = fioInput.value.trim();
        
        submitBtn.disabled = true;
        submitBtn.textContent = "Отправка...";

        fetch(URL_PAID, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            game_id: gameId,
            slot: slot,
            fio: fio,
            user_id: userId,
            username: username
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            tg.showPopup({
              title: "Успешно!",
              message: "Заявка отправлена администратору. Ожидайте подтверждения.",
              buttons: [{type: "ok"}]
            }, function() {
              tg.close();
            });
          } else {
            tg.showPopup({
              title: "Ошибка",
              message: data.error || "Ошибка при отправке.",
              buttons: [{type: "close"}]
            });
            submitBtn.disabled = false;
            submitBtn.textContent = "Отправить заявку";
          }
        })
        .catch(err => {
          tg.showPopup({ title: "Ошибка", message: "Сбой сети." });
          submitBtn.disabled = false;
        });
      });
    });
  </script>
</body>
</html>
