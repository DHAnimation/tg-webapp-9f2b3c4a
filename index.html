<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Оплата номерка</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="robots" content="noindex,nofollow" />

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--tg-theme-secondary-bg-color, #f3f3f3);
      color: var(--tg-theme-text-color, #000000);
    }

    .card {
      max-width: 480px;
      margin: 0 auto;
      background: var(--tg-theme-bg-color, #ffffff);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    /* Стили для экрана загрузки/блокировки */
    #loader-view {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 250px;
      text-align: center;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--tg-theme-hint-color, #ddd);
      border-top-color: var(--tg-theme-button-color, #4caf50);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loader-text {
      font-size: 16px;
      color: var(--tg-theme-text-color, #000);
      font-weight: 500;
    }

    /* Основная форма скрыта по умолчанию */
    #form-view {
      display: none;
    }

    h2 {
      margin: 0 0 12px;
      font-size: 20px;
      font-weight: 700;
      text-align: center;
    }

    .warning {
      margin: 0 0 16px;
      padding: 10px 12px;
      border-radius: 8px;
      background: #fff4cf;
      border: 1px solid #f5d96b;
      font-size: 13px;
      line-height: 1.4;
      color: #5c4b00;
    }

    .field {
      margin-bottom: 12px;
    }

    .field-label {
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 14px;
      color: var(--tg-theme-hint-color, #777);
    }

    .field-box {
      padding: 10px;
      border-radius: 8px;
      background: var(--tg-theme-secondary-bg-color, #fafafa);
      border: 1px solid var(--tg-theme-hint-color, #ddd);
      font-size: 15px;
      white-space: pre-line;
      color: var(--tg-theme-text-color, #000);
    }

    input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--tg-theme-hint-color, #ccc);
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
      font-size: 16px; 
      box-sizing: border-box;
      outline: none;
    }
    
    input:focus {
      border-color: var(--tg-theme-button-color, #4caf50);
    }

    .hint {
      margin-top: 4px;
      color: var(--tg-theme-hint-color, #999);
      font-size: 12px;
    }

    .btn-row {
      margin-top: 20px;
    }

    button {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: var(--tg-theme-button-color, #4caf50);
      color: var(--tg-theme-button-text-color, #fff);
      transition: opacity 0.2s;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 16px;
      font-size: 15px;
    }

    .checkbox-row input {
      width: 20px;
      height: 20px;
      margin: 0;
      accent-color: var(--tg-theme-button-color, #4caf50);
    }
  </style>
</head>
<body>
  <div class="card">
    
    <!-- ЭКРАН 1: Загрузка и Блокировка -->
    <div id="loader-view">
      <div class="spinner"></div>
      <div class="loader-text" id="loader-msg">Проверяем доступность билета...</div>
    </div>

    <!-- ЭКРАН 2: Форма оплаты -->
    <div id="form-view">
      <h2 id="title">Загрузка...</h2>

      <div class="warning">
        <b>ВНИМАНИЕ!</b> Билет забронирован за вами на 5 минут.<br>
        Если вы закроете это окно, бронь <b>мгновенно снимется</b>.<br>
        Переводите точно указанную сумму.
      </div>

      <div class="field">
        <div class="field-label">Сумма к переводу</div>
        <div class="field-box" id="amount-box">— ₽</div>
      </div>

      <div class="field">
        <div class="field-label">Реквизиты для оплаты (СБП)</div>
        <div class="field-box" id="details-box">Загрузка...</div>
      </div>

      <div class="field">
        <div class="field-label">Ваши ФИО (как в банке)</div>
        <input id="fio-input" type="text" placeholder="Иванов Иван Иванович" autocomplete="off" />
        <div class="hint">
          Нужно для проверки платежа администратором.
        </div>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="paid-checkbox" />
        <label for="paid-checkbox">Я перевёл деньги по реквизитам</label>
      </div>

      <div class="btn-row">
        <button id="submit-btn" disabled>Отправить заявку</button>
      </div>
    </div>

  </div>

  <script>
    // === ВАЖНО: АДРЕС ТВОЕГО СЕРВЕРА НА AMVERA ===
    // Убедись, что в конце нет слеша
    const BASE_URL = "https://ufa-bot-dhanimation.amvera.io"; 
    
    // Эндпоинты
    const URL_LOCK = BASE_URL + "/webapp/lock";
    const URL_PAID = BASE_URL + "/webapp/paid";
    const URL_UNLOCK = BASE_URL + "/webapp/unlock"; // Для мгновенной разблокировки

    const tg = window.Telegram.WebApp;

    // Флаг, который показывает, отправляем ли мы заявку.
    // Если true, то при закрытии окна бронь снимать НЕ нужно (так как заявка ушла админу).
    let isSubmitting = false;

    function b64DecodeUnicode(str) {
      if (!str) return "";
      str = str.replace(/-/g, "+").replace(/_/g, "/");
      while (str.length % 4) { str += "="; }
      try {
        return decodeURIComponent(atob(str).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
      } catch (e) {
        console.error("Decode error", e);
        return "";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      tg.ready();
      try { tg.expand(); } catch(e){}

      document.body.style.backgroundColor = tg.themeParams.secondary_bg_color || "#f3f3f3";
      
      let rawParam = "";
      if (tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
        rawParam = b64DecodeUnicode(tg.initDataUnsafe.start_param);
      }

      let gameId = null;
      let slot = null;
      let price = null;
      let bank = "", payName = "", payPhone = "";

      if (rawParam) {
        // game_id:slot:price:bank|name|phone
        const parts = rawParam.split(":");
        if (parts.length >= 3) {
          gameId = parseInt(parts[0]);
          slot = parseInt(parts[1]);
          price = parseInt(parts[2]);
        }
        if (parts.length >= 4) {
          const rest = parts.slice(3).join(":");
          const splitted = rest.split("|");
          bank = splitted[0] || "";
          payName = splitted[1] || "";
          payPhone = splitted[2] || "";
        }
      }

      const loaderView = document.getElementById("loader-view");
      const loaderMsg = document.getElementById("loader-msg");
      const formView = document.getElementById("form-view");

      if (!gameId || !slot) {
        loaderMsg.textContent = "Ошибка: Некорректная ссылка на игру.";
        return;
      }

      // Данные пользователя
      const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 0;
      const username = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.username : null;

      // 1. Пытаемся забронировать слот при открытии
      fetch(URL_LOCK, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({
          game_id: gameId,
          slot: slot,
          user_id: userId,
          username: username
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          // УСПЕХ: Слот наш, показываем форму
          showForm();
        } else {
          // ОШИБКА: Слот занят
          const errorText = data.error || "Этот номерок уже занят или у вас есть неоплаченная бронь.";
          tg.showPopup({
            title: "Доступ запрещен",
            message: errorText,
            buttons: [{type: "close"}]
          }, function() {
            tg.close();
          });
          loaderMsg.textContent = errorText;
        }
      })
      .catch(err => {
        console.error(err);
        loaderMsg.textContent = "Ошибка соединения с сервером.";
        tg.showPopup({
            title: "Ошибка сети",
            message: "Не удалось связаться с ботом.",
            buttons: [{type: "close"}]
        });
      });

      // === ЛОГИКА МГНОВЕННОГО СНЯТИЯ БРОНИ ===
      function sendUnlockBeacon() {
        if (isSubmitting) return; // Если заявка ушла, бронь не снимаем
        if (!gameId || !slot || !userId) return;

        const payload = JSON.stringify({
          game_id: gameId,
          slot: slot,
          user_id: userId
        });

        // sendBeacon работает даже при закрытии вкладки/приложения
        const blob = new Blob([payload], {type: 'application/json'});
        navigator.sendBeacon(URL_UNLOCK, blob);
      }

      // Слушаем события закрытия
      window.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') {
          sendUnlockBeacon();
        }
      });
      window.addEventListener('pagehide', sendUnlockBeacon);


      function showForm() {
        loaderView.style.display = "none";
        formView.style.display = "block";

        const titleEl = document.getElementById("title");
        titleEl.textContent = `Игра #${gameId}, Билет #${slot}`;

        document.getElementById("amount-box").textContent = price ? `${price} ₽` : "—";
        document.getElementById("details-box").innerHTML = `
          Банк: <b>${bank}</b><br>
          Получатель: <b>${payName}</b><br>
          Телефон: <b>${payPhone}</b>
        `;
      }

      // 2. Обработка кнопки оплаты
      const fioInput = document.getElementById("fio-input");
      const paidCheckbox = document.getElementById("paid-checkbox");
      const submitBtn = document.getElementById("submit-btn");

      function updateBtn() {
        const hasFio = fioInput.value.trim().length >= 2;
        submitBtn.disabled = !(hasFio && paidCheckbox.checked);
      }

      fioInput.addEventListener("input", updateBtn);
      paidCheckbox.addEventListener("change", updateBtn);

      submitBtn.addEventListener("click", () => {
        const fio = fioInput.value.trim();
        if (!fio) return;

        // Блокируем интерфейс и ставим флаг
        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.textContent = "Отправка...";

        const payload = {
          game_id: gameId,
          slot: slot,
          fio: fio,
          user_id: userId,
          username: username
        };

        fetch(URL_PAID, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
          if (data.ok) {
            tg.showPopup({
              title: "Заявка принята!",
              message: "Администратор проверит оплату и подтвердит номерок.",
              buttons: [{type: "ok"}]
            }, function() {
              tg.close();
            });
          } else {
            isSubmitting = false; // Возвращаем флаг при ошибке
            tg.showPopup({
              title: "Ошибка",
              message: data.error || "Сбой при отправке.",
              buttons: [{type: "close"}]
            });
            submitBtn.disabled = false;
            submitBtn.textContent = "Отправить заявку";
          }
        })
        .catch(err => {
          isSubmitting = false;
          console.error(err);
          tg.showPopup({
            title: "Ошибка",
            message: "Сбой сети.",
            buttons: [{type: "close"}]
          });
          submitBtn.disabled = false;
          submitBtn.textContent = "Отправить заявку";
        });
      });
    });
  </script>
</body>
</html>
